
# YOLOv11のデプロイ方法

***量子化とデプロイメントの2つの分野に関わるため、不適切な点があればご指摘ください。***

本リポジトリでは、YOLOv11（YOLOv8）の7つの異なるデプロイ方法を試みました。最も基本的なモデルから始めて、デコード関連の操作を段階的に削除し（後処理に移動）、これ以上削減できないところまで、モデルの最も本質的な部分だけを残しました。

デコード関連の操作が後処理に移行するにつれて、モデルの推論時間は減少し、後処理の時間は増加しています。また、デコード操作がモデルから削除されるにつれて、量子化の効果も徐々に向上しています。

各方法の利点について簡単にまとめました。異なるプラットフォーム、異なる時間制約やCPU使用率の要件に応じて、適切な方法が見つかるはずです。また、デプロイメントについて学びたい方にとっても良い参考資料となります。

春節期間中、1日1つのデプロイ方法を試し、充実した春節を過ごしました。

[YOLOv11の7つのデプロイ方法のコードリンク](https://github.com/cqu20160901/yolov11_deploymethods)

このリポジトリでは、RK3588チップを使用し、YOLOv11nモデル、入力解像度640x640、80クラスの検出を行っています。

# 0 七つの方法のまとめ
| 番号 | 推論時間ms | 後処理時間ms | 総時間ms | 前の方法と比べたCPU使用率 | INT8量子化の適合性 |
|--|--|--|--|--|--|
|第1種|--|--|最小|最も単純|不適|
|第2種|33.75|4.4972|38.2472|1と同じ|不適|
|第3種|32.44|4.4971|36.4971|増加|不適|
|第4種|30.78|4.55|35.33|増加|やや適|
|第5種|30.75|4.84|35.58|増加（最大）|やや適|
|第6種|30.24|7.08|37.32|5と同じ|やや適|
|第7種|30.17|7.34|37.51|5と同じ|適|

NPUの負荷がボトルネックでない場合、より多くの操作をNPU上で実行することを検討できます。逆に、一部の操作をCPUに移動することも可能です。量子化による精度低下が大きい場合は、より量子化に適した方法を検討することができます。

承知しました。続きの全文を翻訳いたします：

# 1 コードディレクトリ構造
```python
yolov11_onnx  # ONNXの推論スクリプト、モデル、テスト画像、テスト結果画像
yolov11_rknn  # RKNNへの変換・推論スクリプト、モデル、テスト画像、テスト結果画像
yolov11_cpp   # RK388向けの完全なC++実装コード、モデル、テスト画像、テスト結果画像
```

# 2 YOLOv11（v8）の7つのデプロイ方法
## 2.1 第1のデプロイ方法
### モデル構造
YOLOv11公式のエクスポートされたONNXモデルに従い、モデルの出力は直接クラスと解読後のボックスとなっています。モデル構造は以下の図の通りです。
![モデル構造図1](https://i-blog.csdnimg.cn/direct/a12c54b6a3a1411fa83d738c64d2f628.png)
### ONNX効果
残念ながら、RKNN のINT8モデルに変換すると、何も検出できません。RKNNのINT8への変換時にモデルの出力結果をすべて出力してみると、モデル出力の84次元のうち、最初の4つの座標ボックス値は正常ですが、後の80個のスコア出力がすべて0となっていることがわかりました。この原因は、座標ボックス値の取り得る範囲が1-640であるのに対し、スコア出力の値の範囲が0-1であり、量子化に非常に不適切であることから、モデルのスコア出力値がほぼすべて0になってしまうためです。量子化なしでRKNNに変換すると正常に出力されることを確認しました。したがって、この方法は量子化に適していません。このデプロイ方式ではモデルの処理時間が最も長く、後処理の操作が最も少なくなります。
![ONNX結果図](https://i-blog.csdnimg.cn/direct/e03cc9bfcb8e4975a8abbbc5e720d21f.png)
### ボード上での効果
このデプロイ方法ではRKNNのINT8への量子化効果が非常に悪いため、ボード上での実装は行いませんでした。

## 2.2 第2のデプロイ方法
### モデル構造
第1のデプロイ方法のモデルをベースに、最後の座標ボックスとスコアを結合する操作を削除しました。
![モデル構造図2](https://i-blog.csdnimg.cn/direct/0173b07aa82d4e78b0afbb2292ac3778.png)

### ONNX効果
ONNXのテスト結果は第1の方法と同じため、図は省略します。
### ボード上での効果
第1のデプロイ方法では、座標ボックス値とスコアの取り得る範囲の差が大きく、それらを結合することでINT8モデルへの量子化がほぼ使用不可能でした。この方法では最後の結合を削除することで、量子化後も正常に出力できますが、ボード上でのテスト効果は良好とは言えません。
![ボード結果図2](https://i-blog.csdnimg.cn/direct/7ebdaae21d294fecb1a0e771b03bf802.png)
### ボード上での処理時間
![時間測定図2](https://i-blog.csdnimg.cn/direct/0a3e2ebb351d4b069fc9a89a25b19881.png)

## 2.3 第3のデプロイ方法
### モデル構造
第2のデプロイ方法のモデルをベースに、座標ボックスをモデル入力サイズにデコードする計算を削除しました。
![モデル構造図3](https://i-blog.csdnimg.cn/direct/7f85139d730147fcaa7f242a925be567.png)
### ONNX効果
ONNXのテスト結果は第1の方法と同じため、図は省略します。

### ボード上での効果
![ボード結果図3](https://i-blog.csdnimg.cn/direct/2f7bb99652b943cd9089ff8889ff915a.png)
### ボード上での処理時間
![時間測定図3](https://i-blog.csdnimg.cn/direct/8c581058510241bda5aca44fdd7e3492.png)

## 2.4 第4のデプロイ方法
### モデル構造
第3のデプロイ方法のモデルをベースに、さらに座標ボックスのDFLを削除し、2つのヘッドを出力します。第2、3のデプロイ方法では、量子化に適していない可能性があり、検出効果に明らかな問題がありました。この方法では検出効果に明らかな問題はありません。
![モデル構造図4](https://i-blog.csdnimg.cn/direct/745267836b4e4cfdbfe2e350c17109e6.png)

### ONNX効果
ONNXのテスト結果は第1の方法と同じため、図は省略します。
### ボード上での効果
![ボード結果図4](https://i-blog.csdnimg.cn/direct/e51f271e966e4d0097e706989e4f86b0.png)

### ボード上での処理時間
![時間測定図4](https://i-blog.csdnimg.cn/direct/c79c5d2d3697402fb014e2845f09f8ff.png)

## 2.5 第5のデプロイ方法
### モデル構造
第4のデプロイ方法のモデルをベースに、さらに座標ボックスとスコアを分割するsplit操作、およびスコアのsigmoid関数を削除し、1つのヘッドを出力します。このデプロイ方法に達すると、後処理のCPU使用率はこれ以上増加しません。
![モデル構造図5](https://i-blog.csdnimg.cn/direct/a0a6b37b6eae4c3791cf9480907197e6.png)

### ONNX効果
ONNXのテスト結果は第1の方法と同じため、図は省略します。
### ボード上での効果
![ボード結果図5](https://i-blog.csdnimg.cn/direct/3adc7921e8ae47329f9138db5223d9ca.png)
### ボード上での処理時間
![時間測定図5](https://i-blog.csdnimg.cn/direct/ceee40671af44a338dc1a60f34a21c65.png)

## 2.6 第6のデプロイ方法
### モデル構造
第5のデプロイ方法のモデルをベースに、さらに3つの検出ヘッドを結合する操作を削除し、3つのヘッドを出力します。
![モデル構造図6](https://i-blog.csdnimg.cn/direct/ff20dd54f4e145c2a5e9200734448acf.png)

### ONNX効果
ONNXのテスト結果は第1の方法と同じため、図は省略します。
### ボード上での効果
![ボード結果図6](https://i-blog.csdnimg.cn/direct/f5a68457490a4eb3a0f336ec67963c9c.png)

### ボード上での処理時間
![時間測定図6](https://i-blog.csdnimg.cn/direct/1c2f7275c0164f868883845612601b9d.png)

## 2.7 第7のデプロイ方法
### モデル構造
第6のデプロイ方法のモデルをベースに、さらに3つの検出ヘッドの座標ボックスとスコアを結合する操作を削除し、6つのヘッドを出力します。この段階で、モデル内にカプセル化された操作で削除可能なものはすべて削除され、モデルの速度は最速となり、量子化への適合性も最も良好になりました。
![モデル構造図7](https://i-blog.csdnimg.cn/direct/f5a9bd64fb6f440683f1d47cae8b9b61.png)

### ONNX効果
ONNXのテスト結果は第1の方法と同じため、図は省略します。

### ボード上での効果
![ボード結果図7](https://i-blog.csdnimg.cn/direct/1f69b76c34334e6bb85981c252132714.png)

### ボード上での処理時間
![時間測定図7](https://i-blog.csdnimg.cn/direct/c310bcf013474dd89544280da97dfe5c.png)
